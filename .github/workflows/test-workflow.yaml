name: SDK PR Notebook E2E Runner

on:
  repository_dispatch:
    types: [run-sdk-pr-e2e-tests]

jobs:
  run-notebook-test:
    # ðŸš¨ UPDATE 5: Replace 'ubuntu-latest' with your custom runner label if needed. 
    # If testing on standard GitHub runners, use 'ubuntu-latest'.
    runs-on: ubuntu-latest 
    permissions:
      contents: write # Needed to upload the executed notebook artifact
    
    steps:
      - name: Checkout SDK PR Code
        uses: actions/checkout@v4
        with:
          # This pulls the code from your SDK fork (jdoe/sdk-repo)
          repository: ${{ github.event.client_payload.sdk_repo }}
          ref: ${{ github.event.client_payload.sdk_sha }}
          path: sdk-repo 

      - name: Checkout Training Operator Repo (Test Asset)
        uses: actions/checkout@v4
        with:
          # This pulls the notebook from your Training Operator fork
          repository: ${{ github.event.client_payload.training_operator_repo_owner }}/${{ github.event.client_payload.training_operator_repo_name }}
          ref: ${{ github.event.client_payload.training_operator_ref }}
          path: training-operator-repo 
          
      # --- Test Environment Setup ---
      - name: Set up Python 3.9
        uses: actions/setup-python@v6
        with:
          python-version: '3.9'

      - name: Setup Environment and Install Dependencies
        shell: bash
        run: |
          echo "Installing tools and dependencies..."
          
          # 1. Install Poetry and Papermill tools
          pip install poetry
          pip install papermill==2.6.0 jupyter==1.1.1 ipykernel==6.29.5

          # 2. Install SDK dependencies (from the PR code)
          cd sdk-repo
          poetry install -r --with dev
          
          # Get VENV path for later use
          POETRY_VENV_PATH=$(poetry env info --path)
          
          # 3. Configure Notebook Kernel for Papermill
          $POETRY_VENV_PATH/bin/python -m ipykernel install --user --name=sdk-test-kernel --display-name "Python (SDK Test)"
          
          mkdir -p artifacts/notebooks # Create artifact directory

      - name: Run E2E Notebook Test with Papermill
        id: run-test
        run: |
          POETRY_VENV_PATH=$(cd sdk-repo && poetry env info --path)
          PAPERMILL_BIN="$POETRY_VENV_PATH/bin/papermill"

          # ðŸš¨ UPDATE 6: Update the path below to the exact location of your E2E notebook
          NOTEBOOK_INPUT="opendatahub-io/training-operator/examples/pytorch/image-classification/mnist.ipynb" 
          NOTEBOOK_OUTPUT="artifacts/notebooks/sdk-pr-test-output.ipynb"
          TIMEOUT_SECONDS=900 
          
          echo "Executing notebook for SDK commit: ${{ github.event.client_payload.sdk_sha }}"
          
          $PAPERMILL_BIN $NOTEBOOK_INPUT $NOTEBOOK_OUTPUT \
            --kernel "sdk-test-kernel" \
            --parameters timeout $TIMEOUT_SECONDS \
            --log-level INFO
          
          echo "Notebook test execution finished."

      - name: Upload Executed Notebook Artifact
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: sdk-pr-notebook-result-${{ github.event.client_payload.sdk_sha }}
          path: artifacts/notebooks/sdk-pr-test-output.ipynb
          retention-days: 1